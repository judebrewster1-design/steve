
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∞ Judeceno Casino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-bounce { animation: bounce 1s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white min-h-screen">
    <div id="app"></div>

    <script>
        const API_URL = 'https://avenue-divided-framed-drag.trycloudflare.com';
        let currentUser = null;
        let currentGame = null;
        let isDemo = false;
        let showSettings = false;
        let adminLoggedIn = false;
        let adminPassword = '';

        // State for each game
        let gameStates = {
            blackjack: { bet: 100, gameState: null, loading: false },
            poker: { bet: 100, result: null, loading: false },
            mines: { bet: 100, mineCount: 5, gameActive: false, revealed: [], multiplier: 1.0, gameOver: false, loading: false },
            coinflip: { bet: 100, choice: 'heads', result: null, loading: false, flipping: false },
            roulette: { bet: 100, betType: 'red', result: null, loading: false, spinning: false },
            towers: { bet: 100, difficulty: 'easy', gameActive: false, currentRow: 0, revealed: [], gameOver: false, loading: false, multiplier: 1.0 },
            plinko: { bet: 100, risk: 'medium', result: null, loading: false, dropping: false },
            hilo: { bet: 100, gameActive: false, currentCard: null, nextCard: null, multiplier: 1.0, gameOver: false, loading: false }
        };

        const games = [
            { id: 'blackjack', name: 'Blackjack', icon: 'üÉè', color: 'from-red-500 to-pink-600' },
            { id: 'poker', name: 'Poker', icon: '‚ô†Ô∏è', color: 'from-blue-500 to-cyan-600' },
            { id: 'mines', name: 'Mines', icon: 'üí£', color: 'from-orange-500 to-red-600' },
            { id: 'towers', name: 'Towers', icon: 'üè¢', color: 'from-purple-500 to-pink-600' },
            { id: 'plinko', name: 'Plinko', icon: 'üéØ', color: 'from-yellow-500 to-orange-600' },
            { id: 'roulette', name: 'Roulette', icon: 'üé°', color: 'from-green-500 to-teal-600' },
            { id: 'hilo', name: 'Hi-Lo', icon: 'üìä', color: 'from-indigo-500 to-blue-600' },
            { id: 'coinflip', name: 'Coin Flip', icon: 'ü™ô', color: 'from-gray-500 to-slate-600' }
        ];

        async function handleAuth(isLogin) {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const endpoint = isLogin ? '/login' : '/register';
                const res = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();
                if (res.ok) {
                    currentUser = data;
                    renderMainApp();
                } else {
                    errorDiv.textContent = data.error;
                    errorDiv.classList.remove('hidden');
                }
            } catch (err) {
                errorDiv.textContent = 'Connection failed. Is the server running?';
                errorDiv.classList.remove('hidden');
            }
        }

        function renderAuthScreen() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 w-full max-w-md p-8">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-2">
                                üé∞ Judeceno Casino
                            </h1>
                            <p class="text-gray-400">Your Premium Gaming Destination</p>
                        </div>

                        <div id="error" class="hidden bg-red-500/20 border border-red-500 rounded-lg p-3 mb-4 text-red-300 text-sm"></div>

                        <div class="space-y-4">
                            <input type="text" id="username" placeholder="Username" 
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500">
                            <input type="password" id="password" placeholder="Password"
                                class="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500">
                            <button onclick="handleAuth(true)" class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-all">
                                Login
                            </button>
                            <button onclick="handleAuth(false)" class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold transition-all">
                                Register
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            const balance = isDemo ? currentUser.freeBalance : currentUser.balance;
            
            if (showSettings) {
                renderSettings();
                return;
            }

            document.getElementById('app').innerHTML = `
                <!-- Header -->
                <div class="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 sticky top-0 z-50">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between">
                            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                                üé∞ Judeceno
                            </h1>
                            
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 bg-gray-900 px-4 py-2 rounded-lg">
                                    <span class="text-sm text-gray-400">Mode:</span>
                                    <button onclick="toggleDemo()" class="px-3 py-1 rounded text-sm font-semibold ${isDemo ? 'bg-yellow-600' : 'bg-green-600'}">
                                        ${isDemo ? 'üéÅ Demo' : 'üí∞ Real'}
                                    </button>
                                </div>
                                
                                <div class="bg-gray-900 px-4 py-2 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <span class="text-green-400">üíµ</span>
                                        <span class="font-bold">$${(balance / 100).toFixed(2)}</span>
                                    </div>
                                </div>

                                <button onclick="showBugReport()" class="p-2 bg-gray-900 rounded-lg hover:bg-gray-700 transition-colors" title="Report Bug">
                                    üêõ
                                </button>

                                <button onclick="openSettings()" class="p-2 bg-gray-900 rounded-lg hover:bg-gray-700 transition-colors" title="Settings">
                                    ‚öôÔ∏è
                                </button>

                                <button onclick="logout()" class="p-2 bg-gray-900 rounded-lg hover:bg-red-700 transition-colors" title="Logout">
                                    üö™
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <div id="game-container">
                        ${currentGame ? renderGame(currentGame) : renderGameSelection()}
                    </div>
                </div>

                <!-- Bug Report Modal -->
                <div id="bug-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
                    <div class="bg-gray-800 rounded-lg border border-gray-700 w-full max-w-md p-6">
                        <h3 class="text-2xl font-bold mb-4">üêõ Report a Bug</h3>
                        <div class="space-y-4">
                            <select id="bug-game" class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                                <option value="">Select Game</option>
                                ${games.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}
                            </select>
                            <textarea id="bug-description" placeholder="Describe the bug..." 
                                class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white h-32 resize-none"></textarea>
                            <div class="flex gap-2">
                                <button onclick="submitBugReport()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold">
                                    Submit Report
                                </button>
                                <button onclick="closeBugReport()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSettings() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen p-4">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-3xl font-bold">‚öôÔ∏è Settings</h2>
                                <button onclick="closeSettings()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg">
                                    ‚Üê Back
                                </button>
                            </div>

                            <div class="space-y-6">
                                <!-- User Info -->
                                <div class="bg-gray-900 rounded-lg p-4">
                                    <h3 class="text-xl font-bold mb-3">üë§ Account Information</h3>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Username:</span>
                                            <span class="font-bold">${currentUser.username}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Real Balance:</span>
                                            <span class="font-bold text-green-400">$${(currentUser.balance / 100).toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Demo Balance:</span>
                                            <span class="font-bold text-yellow-400">$${(currentUser.freeBalance / 100).toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Admin Panel -->
                                <div class="bg-gray-900 rounded-lg p-4 border-t-4 border-red-500">
                                    <h3 class="text-xl font-bold mb-3">üîê Admin Panel</h3>
                                    
                                    ${!adminLoggedIn ? `
                                        <div class="space-y-3">
                                            <input type="password" id="admin-password" placeholder="Admin Password" 
                                                class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                                            <button onclick="loginAdmin()" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-semibold">
                                                Login as Admin
                                            </button>
                                            <p class="text-sm text-gray-400 text-center">Admin access required to manage casino</p>
                                        </div>
                                    ` : `
                                        <div id="admin-content" class="space-y-4">
                                            <div class="flex items-center justify-between p-3 bg-green-500/20 rounded-lg border border-green-500">
                                                <span class="text-green-300 font-semibold">‚úÖ Admin Access Granted</span>
                                                <button onclick="logoutAdmin()" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                                                    Logout
                                                </button>
                                            </div>

                                            <!-- Tabs -->
                                            <div class="flex gap-2 border-b border-gray-700">
                                                <button onclick="showAdminTab('users')" id="tab-users" class="px-4 py-2 font-semibold border-b-2 border-purple-500">
                                                    Users
                                                </button>
                                                <button onclick="showAdminTab('games')" id="tab-games" class="px-4 py-2 font-semibold border-b-2 border-transparent hover:border-gray-600">
                                                    Games
                                                </button>
                                                <button onclick="showAdminTab('bugs')" id="tab-bugs" class="px-4 py-2 font-semibold border-b-2 border-transparent hover:border-gray-600">
                                                    Bug Reports
                                                </button>
                                                <button onclick="showAdminTab('stats')" id="tab-stats" class="px-4 py-2 font-semibold border-b-2 border-transparent hover:border-gray-600">
                                                    Statistics
                                                </button>
                                            </div>

                                            <div id="admin-tab-content">
                                                Loading...
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (adminLoggedIn) {
                showAdminTab('users');
            }
        }

        async function loginAdmin() {
            const password = document.getElementById('admin-password').value;
            
            try {
                const res = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (res.ok) {
                    adminLoggedIn = true;
                    adminPassword = password;
                    renderSettings();
                } else {
                    alert('Invalid admin password');
                }
            } catch (err) {
                alert('Error connecting to server');
            }
        }

        function logoutAdmin() {
            adminLoggedIn = false;
            adminPassword = '';
            renderSettings();
        }

        async function showAdminTab(tab) {
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('border-purple-500');
                btn.classList.add('border-transparent');
            });
            document.getElementById(`tab-${tab}`).classList.remove('border-transparent');
            document.getElementById(`tab-${tab}`).classList.add('border-purple-500');

            const content = document.getElementById('admin-tab-content');
            content.innerHTML = '<div class="text-center py-8">Loading...</div>';

            if (tab === 'users') {
                await renderUsersTab();
            } else if (tab === 'games') {
                await renderGamesTab();
            } else if (tab === 'bugs') {
                await renderBugsTab();
            } else if (tab === 'stats') {
                await renderStatsTab();
            }
        }

        async function renderUsersTab() {
            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'X-Admin-Password': adminPassword }
                });
                const data = await res.json();
                
                const content = document.getElementById('admin-tab-content');
                content.innerHTML = `
                    <div class="space-y-3">
                        <h4 class="font-bold text-lg">Manage Users (${data.users.length})</h4>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${data.users.map(user => `
                                <div class="bg-gray-800 p-3 rounded-lg flex items-center justify-between">
                                    <div>
                                        <div class="font-bold">${user.username}</div>
                                        <div class="text-sm text-gray-400">
                                            Balance: $${(user.balance / 100).toFixed(2)} | 
                                            Demo: $${(user.freeBalance / 100).toFixed(2)}
                                        </div>
                                    </div>
                                    <button onclick="showGiveFunds('${user.username}')" 
                                        class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">
                                        üí∞ Give Funds
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (err) {
                document.getElementById('admin-tab-content').innerHTML = 
                    '<div class="text-red-400 text-center py-8">Error loading users</div>';
            }
        }

        function showGiveFunds(username) {
            const amount = prompt(`Enter amount to give to ${username} (in cents, e.g., 10000 = $100.00):`);
            if (amount && !isNaN(amount)) {
                giveFunds(username, parseInt(amount));
            }
        }

        async function giveFunds(username, amount) {
            try {
                const res = await fetch(`${API_URL}/admin/give-funds`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({ username, amount })
                });

                if (res.ok) {
                    alert(`Successfully gave $${(amount / 100).toFixed(2)} to ${username}`);
                    showAdminTab('users');
                } else {
                    alert('Failed to give funds');
                }
            } catch (err) {
                alert('Error connecting to server');
            }
        }

        async function renderGamesTab() {
            try {
                const res = await fetch(`${API_URL}/api/game-status`);
                const data = await res.json();
                
                const content = document.getElementById('admin-tab-content');
                content.innerHTML = `
                    <div class="space-y-3">
                        <h4 class="font-bold text-lg">Game Status Control</h4>
                        <div class="space-y-2">
                            ${Object.keys(data).map(gameName => `
                                <div class="bg-gray-800 p-3 rounded-lg flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">${games.find(g => g.id === gameName)?.icon || 'üéÆ'}</span>
                                        <div>
                                            <div class="font-bold capitalize">${gameName}</div>
                                            <div class="text-sm ${data[gameName].active ? 'text-green-400' : 'text-red-400'}">
                                                ${data[gameName].active ? '‚úÖ Active' : 'üî¥ Disabled'}
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="toggleGameStatus('${gameName}', ${!data[gameName].active})" 
                                        class="px-3 py-1 ${data[gameName].active ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} rounded">
                                        ${data[gameName].active ? 'Disable' : 'Enable'}
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (err) {
                document.getElementById('admin-tab-content').innerHTML = 
                    '<div class="text-red-400 text-center py-8">Error loading game status</div>';
            }
        }

        async function toggleGameStatus(gameName, active) {
            try {
                const res = await fetch(`${API_URL}/admin/game-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({ game: gameName, active })
                });

                if (res.ok) {
                    showAdminTab('games');
                } else {
                    alert('Failed to update game status');
                }
            } catch (err) {
                alert('Error connecting to server');
            }
        }

        async function renderBugsTab() {
            try {
                const res = await fetch(`${API_URL}/admin/bug-reports`, {
                    headers: { 'X-Admin-Password': adminPassword }
                });
                const data = await res.json();
                
                const pendingBugs = data.reports.filter(r => r.status === 'pending');
                
                const content = document.getElementById('admin-tab-content');
                content.innerHTML = `
                    <div class="space-y-3">
                        <h4 class="font-bold text-lg">Bug Reports (${pendingBugs.length} pending)</h4>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${pendingBugs.length === 0 ? 
                                '<div class="text-center text-gray-400 py-8">No pending bug reports</div>' :
                                pendingBugs.map(bug => `
                                    <div class="bg-gray-800 p-3 rounded-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="font-bold">${bug.username} - ${bug.game}</div>
                                            <div class="text-sm text-gray-400">
                                                ${new Date(bug.timestamp * 1000).toLocaleString()}
                                            </div>
                                        </div>
                                        <div class="text-sm text-gray-300 mb-3">${bug.description}</div>
                                        <div class="flex gap-2">
                                            <button onclick="acceptBug('${bug.id}')" 
                                                class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm">
                                                ‚úÖ Accept ($0.25 reward)
                                            </button>
                                            <button onclick="rejectBug('${bug.id}')" 
                                                class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                                                ‚ùå Reject
                                            </button>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                `;
            } catch (err) {
                document.getElementById('admin-tab-content').innerHTML = 
                    '<div class="text-red-400 text-center py-8">Error loading bug reports</div>';
            }
        }

        async function acceptBug(reportId) {
            try {
                const res = await fetch(`${API_URL}/admin/bug-reports/${reportId}/accept`, {
                    method: 'POST',
                    headers: { 'X-Admin-Password': adminPassword }
                });

                if (res.ok) {
                    alert('Bug report accepted and user rewarded $0.25!');
                    showAdminTab('bugs');
                } else {
                    alert('Failed to accept bug report');
                }
            } catch (err) {
                alert('Error connecting to server');
            }
        }

        async function rejectBug(reportId) {
            try {
                const res = await fetch(`${API_URL}/admin/bug-reports/${reportId}/reject`, {
                    method: 'POST',
                    headers: { 'X-Admin-Password': adminPassword }
                });

                if (res.ok) {
                    alert('Bug report rejected');
                    showAdminTab('bugs');
                } else {
                    alert('Failed to reject bug report');
                }
            } catch (err) {
                alert('Error connecting to server');
            }
        }

        async function renderStatsTab() {
            try {
                const res = await fetch(`${API_URL}/admin/stats`, {
                    headers: { 'X-Admin-Password': adminPassword }
                });
                const data = await res.json();
                
                const content = document.getElementById('admin-tab-content');
                content.innerHTML = `
                    <div class="space-y-3">
                        <h4 class="font-bold text-lg">Casino Statistics</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400 text-sm">Total Users</div>
                                <div class="text-2xl font-bold">${data.totalUsers}</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400 text-sm">Total Real Balance</div>
                                <div class="text-2xl font-bold text-green-400">$${(data.totalBalance / 100).toFixed(2)}</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400 text-sm">Total Demo Balance</div>
                                <div class="text-2xl font-bold text-yellow-400">$${(data.totalFreeBalance / 100).toFixed(2)}</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400 text-sm">Active Games</div>
                                <div class="text-2xl font-bold">${data.activeGames}</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400 text-sm">Pending Bug Reports</div>
                                <div class="text-2xl font-bold text-orange-400">${data.pendingBugReports}</div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-gray-400 text-sm">Games Played</div>
                                <div class="text-2xl font-bold">${data.totalGamesPlayed}</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                document.getElementById('admin-tab-content').innerHTML = 
                    '<div class="text-red-400 text-center py-8">Error loading statistics</div>';
            }
        }

        function openSettings() {
            showSettings = true;
            renderMainApp();
        }

        function closeSettings() {
            showSettings = false;
            renderMainApp();
        }

        function renderGameSelection() {
            return `
                <div class="text-center mb-12">
                    <h2 class="text-4xl font-bold mb-2">Welcome, ${currentUser.username}! üéâ</h2>
                    <p class="text-gray-400">Choose your game and let's win big!</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${games.map(game => `
                        <button onclick="selectGame('${game.id}')" 
                            class="group relative overflow-hidden rounded-xl bg-gradient-to-br from-gray-800 to-gray-900 p-6 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-purple-500/20">
                            <div class="absolute inset-0 bg-gradient-to-br ${game.color} opacity-0 group-hover:opacity-10 transition-opacity"></div>
                            <div class="relative">
                                <div class="text-5xl mb-3">${game.icon}</div>
                                <h3 class="text-xl font-bold mb-1">${game.name}</h3>
                                <p class="text-gray-400 text-sm">Click to play</p>
                            </div>
                        </button>
                    `).join('')}
                </div>
            `;
        }

        function renderGame(gameId) {
            const gameRenderers = {
                blackjack: renderBlackjack,
                poker: renderPoker,
                mines: renderMines,
                coinflip: renderCoinFlip,
                roulette: renderRoulette,
                towers: renderTowers,
                plinko: renderPlinko,
                hilo: renderHiLo
            };

            return `
                <button onclick="backToGames()" class="mb-4 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors">
                    ‚Üê Back to Games
                </button>
                ${gameRenderers[gameId]()}
            `;
        }

        function renderCard(card) {
            if (!card) return '<div class="w-20 h-28 bg-purple-600 rounded-lg border-2 border-white/20 flex items-center justify-center"><div class="text-3xl">üÇ†</div></div>';
            const suitSymbols = { hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£', spades: '‚ô†' };
            const colorClass = card.color === 'red' ? 'text-red-600' : 'text-black';
            return `
                <div class="w-20 h-28 bg-white rounded-lg border-2 flex flex-col items-center justify-center ${colorClass}">
                    <div class="text-2xl font-bold">${card.value}</div>
                    <div class="text-3xl">${suitSymbols[card.suit]}</div>
                </div>
            `;
        }

        // BLACKJACK
        function renderBlackjack() {
            const state = gameStates.blackjack;
            const gs = state.gameState;

            if (!gs || gs.result) {
                return `
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold mb-6 text-center">üÉè Blackjack</h2>
                        ${gs?.result ? `
                            <div class="p-4 rounded-lg text-center text-xl font-bold mb-4 ${gs.result.win > 0 ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">
                                ${gs.result.message} ${gs.result.win > 0 ? `- Won ${(gs.result.win / 100).toFixed(2)}!` : ''}
                            </div>
                        ` : ''}
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Bet Amount ($)</label>
                                <input type="number" id="bj-bet" value="${state.bet / 100}" min="1" step="1"
                                    onchange="gameStates.blackjack.bet = parseInt(this.value * 100)"
                                    class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                            </div>
                            <button onclick="dealBlackjack()" ${state.loading ? 'disabled' : ''} class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold disabled:opacity-50">
                                ${state.loading ? 'Dealing...' : `Deal Cards - ${(state.bet / 100).toFixed(2)}`}
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-6 text-center">üÉè Blackjack</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-center">Dealer's Hand</h3>
                            <div class="flex gap-2 justify-center">
                                ${gs.dealerHand.map(card => renderCard(card)).join('')}
                            </div>
                            ${gs.dealerScore ? `<div class="text-center mt-2 text-xl font-bold">Score: ${gs.dealerScore}</div>` : ''}
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-center">Your Hand</h3>
                            <div class="flex gap-2 justify-center">
                                ${gs.playerHand.map(card => renderCard(card)).join('')}
                            </div>
                            <div class="text-center mt-2 text-xl font-bold">Score: ${gs.playerScore}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="hitBlackjack()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold">
                                Hit
                            </button>
                            <button onclick="standBlackjack()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-semibold">
                                Stand
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function dealBlackjack() {
            const bet = gameStates.blackjack.bet;
            gameStates.blackjack.loading = true;
            renderMainApp();

            try {
                const res = await fetch(`${API_URL}/game/blackjack/deal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username, bet, isDemo })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Error dealing cards');
                    gameStates.blackjack.loading = false;
                    renderMainApp();
                    return;
                }
                
                gameStates.blackjack.gameState = data;
                if (data.balance !== undefined) updateBalance(data.balance);
            } catch (err) {
                alert('Error: ' + err.message);
            }
            gameStates.blackjack.loading = false;
            renderMainApp();
        }

        async function hitBlackjack() {
            try {
                const res = await fetch(`${API_URL}/game/blackjack/hit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username })
                });
                const data = await res.json();
                gameStates.blackjack.gameState = { ...gameStates.blackjack.gameState, ...data };
                renderMainApp();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function standBlackjack() {
            try {
                const res = await fetch(`${API_URL}/game/blackjack/stand`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username })
                });
                const data = await res.json();
                gameStates.blackjack.gameState = { ...gameStates.blackjack.gameState, ...data };
                if (data.balance !== undefined) updateBalance(data.balance);
                renderMainApp();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // POKER
        function renderPoker() {
            const state = gameStates.poker;

            return `
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-6 text-center">‚ô†Ô∏è Poker</h2>
                    ${state.result ? `
                        <div class="mb-6">
                            <div class="p-4 rounded-lg text-center text-xl font-bold mb-4 ${state.result.win > 0 ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">
                                ${state.result.message} ${state.result.win > 0 ? `- Won ${(state.result.win / 100).toFixed(2)}!` : ''}
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-center">Your Hand</h3>
                                <div class="flex gap-2 justify-center">
                                    ${state.result.playerHand.map(card => renderCard(card)).join('')}
                                </div>
                            </div>
                            <div class="mt-4">
                                <h3 class="text-lg font-semibold mb-3 text-center">Dealer's Hand</h3>
                                <div class="flex gap-2 justify-center">
                                    ${state.result.dealerHand.map(card => renderCard(card)).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Bet Amount ($)</label>
                            <input type="number" id="poker-bet" value="${state.bet / 100}" min="1" step="1"
                                onchange="gameStates.poker.bet = parseInt(this.value * 100)"
                                class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                        </div>
                        <button onclick="dealPoker()" ${state.loading ? 'disabled' : ''} class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold disabled:opacity-50">
                            ${state.loading ? 'Dealing...' : `Deal Cards - ${(state.bet / 100).toFixed(2)}`}
                        </button>
                    </div>
                </div>
            `;
        }

        async function dealPoker() {
            const bet = gameStates.poker.bet;
            gameStates.poker.loading = true;
            renderMainApp();

            try {
                const res = await fetch(`${API_URL}/game/poker/deal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username, bet, isDemo })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Error dealing cards');
                    gameStates.poker.loading = false;
                    renderMainApp();
                    return;
                }
                
                gameStates.poker.result = data;
                if (data.balance !== undefined) updateBalance(data.balance);
            } catch (err) {
                alert('Error: ' + err.message);
            }
            gameStates.poker.loading = false;
            renderMainApp();
        }

        // MINES
        function renderMines() {
            const state = gameStates.mines;

            if (!state.gameActive) {
                return `
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold mb-6 text-center">üí£ Mines</h2>
                        ${state.gameOver ? `
                            <div class="p-4 rounded-lg text-center text-xl font-bold mb-4 ${!state.hitMine ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">
                                ${state.hitMine ? 'Hit a Mine! üí•' : `Cashed Out! Won ${(state.winAmount / 100).toFixed(2)} (${state.multiplier}x)`}
                            </div>
                        ` : ''}
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Bet Amount ($)</label>
                                <input type="number" value="${state.bet / 100}" min="1" step="1"
                                    onchange="gameStates.mines.bet = parseInt(this.value * 100)"
                                    class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Number of Mines</label>
                                <input type="number" value="${state.mineCount}" min="1" max="24" step="1"
                                    onchange="gameStates.mines.mineCount = parseInt(this.value)"
                                    class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                            </div>
                            <button onclick="startMines()" ${state.loading ? 'disabled' : ''} class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold disabled:opacity-50">
                                ${state.loading ? 'Starting...' : 'Start Game'}
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4 text-center">üí£ Mines</h2>
                    <div class="mb-4 text-center">
                        <div class="text-2xl font-bold text-green-400">Multiplier: ${state.multiplier}x</div>
                        <div class="text-lg text-gray-400">Potential Win: ${((state.bet * state.multiplier) / 100).toFixed(2)}</div>
                    </div>
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        ${Array.from({length: 25}, (_, i) => {
                            const isRevealed = state.revealed.includes(i);
                            return `
                                <button onclick="revealMine(${i})" 
                                    ${isRevealed ? 'disabled' : ''}
                                    class="aspect-square ${isRevealed ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'} rounded-lg text-2xl font-bold disabled:opacity-100">
                                    ${isRevealed ? 'üíé' : ''}
                                </button>
                            `;
                        }).join('')}
                    </div>
                    <button onclick="cashoutMines()" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">
                        Cash Out - ${((state.bet * state.multiplier) / 100).toFixed(2)}
                    </button>
                </div>
            `;
        }

        async function startMines() {
            gameStates.mines.loading = true;
            gameStates.mines.revealed = [];
            gameStates.mines.multiplier = 1.0;
            gameStates.mines.gameOver = false;
            renderMainApp();

            try {
                const res = await fetch(`${API_URL}/game/mines/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: currentUser.username, 
                        bet: gameStates.mines.bet,
                        mineCount: gameStates.mines.mineCount,
                        isDemo 
                    })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Error starting game');
                    gameStates.mines.loading = false;
                    renderMainApp();
                    return;
                }
                
                if (data.balance !== undefined) updateBalance(data.balance);
                gameStates.mines.gameActive = true;
            } catch (err) {
                alert('Error: ' + err.message);
            }
            gameStates.mines.loading = false;
            renderMainApp();
        }

        async function revealMine(index) {
            try {
                const res = await fetch(`${API_URL}/game/mines/reveal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username, index })
                });
                const data = await res.json();
                
                if (data.result.hit === 'mine') {
                    gameStates.mines.gameActive = false;
                    gameStates.mines.gameOver = true;
                    gameStates.mines.hitMine = true;
                } else {
                    gameStates.mines.revealed.push(index);
                    gameStates.mines.multiplier = data.result.multiplier;
                }
                renderMainApp();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function cashoutMines() {
            try {
                const res = await fetch(`${API_URL}/game/mines/cashout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username })
                });
                const data = await res.json();
                
                if (data.balance !== undefined) updateBalance(data.balance);
                gameStates.mines.gameActive = false;
                gameStates.mines.gameOver = true;
                gameStates.mines.hitMine = false;
                gameStates.mines.winAmount = data.winAmount;
                renderMainApp();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // COINFLIP
        function renderCoinFlip() {
            const state = gameStates.coinflip;

            return `
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-6 text-center">ü™ô Coin Flip</h2>
                    ${state.result ? `
                        <div class="mb-6">
                            <div class="text-center mb-4">
                                <div class="text-6xl mb-4 ${state.flipping ? 'animate-spin' : ''}">${state.result.outcome === 'heads' ? 'üëë' : 'ü¶Ö'}</div>
                                <div class="text-2xl font-bold">${state.result.outcome.toUpperCase()}</div>
                            </div>
                            <div class="p-4 rounded-lg text-center text-xl font-bold ${state.result.isWin ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">
                                ${state.result.isWin ? `You Win! +${(state.result.winAmount / 100).toFixed(2)}` : 'You Lose!'}
                            </div>
                        </div>
                    ` : ''}
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Bet Amount ($)</label>
                            <input type="number" value="${state.bet / 100}" min="1" step="1"
                                onchange="gameStates.coinflip.bet = parseInt(this.value * 100)"
                                class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="gameStates.coinflip.choice = 'heads'; renderMainApp()" 
                                class="flex-1 px-4 py-3 ${state.choice === 'heads' ? 'bg-purple-600' : 'bg-gray-700'} hover:bg-purple-700 rounded-lg font-semibold">
                                üëë Heads
                            </button>
                            <button onclick="gameStates.coinflip.choice = 'tails'; renderMainApp()" 
                                class="flex-1 px-4 py-3 ${state.choice === 'tails' ? 'bg-purple-600' : 'bg-gray-700'} hover:bg-purple-700 rounded-lg font-semibold">
                                ü¶Ö Tails
                            </button>
                        </div>
                        <button onclick="flipCoin()" ${state.loading ? 'disabled' : ''} class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold disabled:opacity-50">
                            ${state.loading ? 'Flipping...' : `Flip - ${(state.bet / 100).toFixed(2)}`}
                        </button>
                    </div>
                </div>
            `;
        }

        async function flipCoin() {
            gameStates.coinflip.loading = true;
            gameStates.coinflip.flipping = true;
            renderMainApp();

            try {
                const res = await fetch(`${API_URL}/game/coinflip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: currentUser.username, 
                        bet: gameStates.coinflip.bet,
                        choice: gameStates.coinflip.choice,
                        isDemo 
                    })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Error flipping coin');
                    gameStates.coinflip.loading = false;
                    gameStates.coinflip.flipping = false;
                    renderMainApp();
                    return;
                }
                
                setTimeout(() => {
                    gameStates.coinflip.result = data;
                    if (data.balance !== undefined) updateBalance(data.balance);
                    gameStates.coinflip.loading = false;
                    gameStates.coinflip.flipping = false;
                    renderMainApp();
                }, 1000);
            } catch (err) {
                alert('Error: ' + err.message);
                gameStates.coinflip.loading = false;
                gameStates.coinflip.flipping = false;
                renderMainApp();
            }
        }

        // ROULETTE
        function renderRoulette() {
            const state = gameStates.roulette;

            return `
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-6 text-center">üé° Roulette</h2>
                    ${state.result ? `
                        <div class="mb-6">
                            <div class="text-center mb-4">
                                <div class="text-6xl mb-4 ${state.spinning ? 'animate-spin' : ''}}">üé°</div>
                                <div class="text-3xl font-bold mb-2">${state.result.outcome}</div>
                            </div>
                            <div class="p-4 rounded-lg text-center text-xl font-bold ${state.result.isWin ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">
                                ${state.result.isWin ? `You Win! +${(state.result.winAmount / 100).toFixed(2)}` : 'You Lose!'}
                            </div>
                        </div>
                    ` : ''}
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Bet Amount ($)</label>
                            <input type="number" value="${state.bet / 100}" min="1" step="1"
                                onchange="gameStates.roulette.bet = parseInt(this.value * 100)"
                                class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="gameStates.roulette.betType = 'red'; renderMainApp()" 
                                class="px-4 py-3 ${state.betType === 'red' ? 'bg-red-600' : 'bg-gray-700'} hover:bg-red-700 rounded-lg font-semibold">
                                üî¥ Red (2x)
                            </button>
                            <button onclick="gameStates.roulette.betType = 'black'; renderMainApp()" 
                                class="px-4 py-3 ${state.betType === 'black' ? 'bg-gray-900 border-2 border-white' : 'bg-gray-700'} hover:bg-gray-900 rounded-lg font-semibold">
                                ‚ö´ Black (2x)
                            </button>
                            <button onclick="gameStates.roulette.betType = 'green'; renderMainApp()" 
                                class="px-4 py-3 ${state.betType === 'green' ? 'bg-green-600' : 'bg-gray-700'} hover:bg-green-700 rounded-lg font-semibold">
                                üü¢ Green (36x)
                            </button>
                            <button onclick="gameStates.roulette.betType = 'even'; renderMainApp()" 
                                class="px-4 py-3 ${state.betType === 'even' ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700 rounded-lg font-semibold">
                                Even (2x)
                            </button>
                            <button onclick="gameStates.roulette.betType = 'odd'; renderMainApp()" 
                                class="px-4 py-3 ${state.betType === 'odd' ? 'bg-blue-600' : 'bg-gray-700'} hover:bg-blue-700 rounded-lg font-semibold">
                                Odd (2x)
                            </button>
                        </div>
                        <button onclick="spinRoulette()" ${state.loading ? 'disabled' : ''} class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold disabled:opacity-50">
                            ${state.loading ? 'Spinning...' : `Spin - ${(state.bet / 100).toFixed(2)}`}
                        </button>
                    </div>
                </div>
            `;
        }

        async function spinRoulette() {
            gameStates.roulette.loading = true;
            gameStates.roulette.spinning = true;
            renderMainApp();

            try {
                const res = await fetch(`${API_URL}/game/roulette`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: currentUser.username, 
                        bet: gameStates.roulette.bet,
                        betType: gameStates.roulette.betType,
                        isDemo 
                    })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Error spinning roulette');
                    gameStates.roulette.loading = false;
                    gameStates.roulette.spinning = false;
                    renderMainApp();
                    return;
                }
                
                setTimeout(() => {
                    gameStates.roulette.result = data;
                    if (data.balance !== undefined) updateBalance(data.balance);
                    gameStates.roulette.loading = false;
                    gameStates.roulette.spinning = false;
                    renderMainApp();
                }, 2000);
            } catch (err) {
                alert('Error: ' + err.message);
                gameStates.roulette.loading = false;
                gameStates.roulette.spinning = false;
                renderMainApp();
            }
        }

        // TOWERS
        function renderTowers() {
            const state = gameStates.towers;

            if (!state.gameActive) {
                return `
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold mb-6 text-center">üè¢ Towers</h2>
                        ${state.gameOver ? `
                            <div class="p-4 rounded-lg text-center text-xl font-bold mb-4 ${!state.hitBomb ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">
                                ${state.hitBomb ? 'Hit a Bomb! üí•' : `Won ${(state.winAmount / 100).toFixed(2)} (${state.multiplier}x)`}
                            </div>
                        ` : ''}
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Bet Amount ($)</label>
                                <input type="number" value="${state.bet / 100}" min="1" step="1"
                                    onchange="gameStates.towers.bet = parseInt(this.value * 100)"
                                    class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Difficulty</label>
                                <select onchange="gameStates.towers.difficulty = this.value" class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                                    <option value="easy" ${state.difficulty === 'easy' ? 'selected' : ''}>Easy (1 bomb)</option>
                                    <option value="hard" ${state.difficulty === 'hard' ? 'selected' : ''}>Hard (2 bombs)</option>
                                </select>
                            </div>
                            <button onclick="startTowers()" ${state.loading ? 'disabled' : ''} class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold disabled:opacity-50">
                                ${state.loading ? 'Starting...' : 'Start Game'}
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4 text-center">üè¢ Towers</h2>
                    <div class="mb-4 text-center">
                        <div class="text-2xl font-bold text-green-400">Row: ${state.currentRow + 1}/8</div>
                        <div class="text-lg text-gray-400">Current Multiplier: ${state.multiplier}x</div>
                    </div>
                    <div class="space-y-2 mb-4">
                        ${Array.from({length: 8}, (_, row) => {
                            const displayRow = 7 - row;
                            return `
                                <div class="flex gap-2 justify-center">
                                    ${Array.from({length: 3}, (_, col) => {
                                        const isRevealed = state.revealed.some(r => r.row === displayRow && r.col === col);
                                        const canClick = displayRow === state.currentRow;
                                        return `
                                            <button onclick="pickTower(${displayRow}, ${col})" 
                                                ${!canClick || isRevealed ? 'disabled' : ''}
                                                class="w-20 h-16 ${isRevealed ? (state.revealed.find(r => r.row === displayRow && r.col === col).bomb ? 'bg-red-600' : 'bg-green-600') : canClick ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-800'} rounded-lg text-2xl font-bold disabled:opacity-50">
                                                ${isRevealed ? (state.revealed.find(r => r.row === displayRow && r.col === col).bomb ? 'üí£' : 'üíé') : ''}
                                            </button>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${state.currentRow > 0 ? `
                        <button onclick="cashoutTowers()" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">
                            Cash Out - ${((state.bet * state.multiplier) / 100).toFixed(2)}
                        </button>
                    ` : ''}
                </div>
            `;
        }

        async function startTowers() {
            gameStates.towers.loading = true;
            gameStates.towers.revealed = [];
            gameStates.towers.currentRow = 0;
            gameStates.towers.multiplier = 1.0;
            gameStates.towers.gameOver = false;
            renderMainApp();

            try {
                const res = await fetch(`${API_URL}/game/towers/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: currentUser.username, 
                        bet: gameStates.towers.bet,
                        difficulty: gameStates.towers.difficulty,
                        isDemo 
                    })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Error starting game');
                    gameStates.towers.loading = false;
                    renderMainApp();
                    return;
                }
                
                if (data.balance !== undefined) updateBalance(data.balance);
                gameStates.towers.gameActive = true;
            } catch (err) {
                alert('Error: ' + err.message);
            }
            gameStates.towers.loading = false;
            renderMainApp();
        }

        async function pickTower(row, col) {
            try {
                const res = await fetch(`${API_URL}/game/towers/pick`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username, row, col })
                });
                const data = await res.json();
                
                gameStates.towers.revealed.push({ row, col, bomb: data.isBomb });
                
                if (data.isBomb) {
                    gameStates.towers.gameActive = false;
                    gameStates.towers.gameOver = true;
                    gameStates.towers.hitBomb = true;
                } else if (data.gameOver) {
                    gameStates.towers.gameActive = false;
                    gameStates.towers.gameOver = true;
                    gameStates.towers.hitBomb = false;
                    gameStates.towers.winAmount = data.winAmount;
                    if (data.balance !== undefined) updateBalance(data.balance);
                } else {
                    gameStates.towers.currentRow = data.currentRow;
                    gameStates.towers.multiplier = data.multiplier;
                }
                renderMainApp();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function cashoutTowers() {
            try {
                const res = await fetch(`${API_URL}/game/towers/cashout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username })
                });
                const data = await res.json();
                
                if (data.balance !== undefined) updateBalance(data.balance);
                gameStates.towers.gameActive = false;
                gameStates.towers.gameOver = true;
                gameStates.towers.hitBomb = false;
                gameStates.towers.winAmount = data.winAmount;
                renderMainApp();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // PLINKO
        function renderPlinko() {
            const state = gameStates.plinko;

            return `
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-6 text-center">üéØ Plinko</h2>
                    ${state.result ? `
                        <div class="mb-6">
                            <div class="text-center mb-4">
                                <div class="text-6xl mb-4 ${state.dropping ? 'animate-bounce' : ''}">üîµ</div>
                                <div class="text-2xl font-bold">Slot ${state.result.slot} - ${state.result.multiplier}x</div>
                            </div>
                            <div class="p-4 rounded-lg text-center text-xl font-bold ${state.result.winAmount >= state.bet ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">
                                ${state.result.winAmount >= state.bet ? `Won ${(state.result.winAmount / 100).toFixed(2)}!` : `Lost ${((state.bet - state.result.winAmount) / 100).toFixed(2)}`}
                            </div>
                        </div>
                    ` : ''}
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Bet Amount ($)</label>
                            <input type="number" value="${state.bet / 100}" min="1" step="1"
                                onchange="gameStates.plinko.bet = parseInt(this.value * 100)"
                                class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Risk Level</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="gameStates.plinko.risk = 'low'; renderMainApp()" 
                                    class="px-4 py-3 ${state.risk === 'low' ? 'bg-green-600' : 'bg-gray-700'} hover:bg-green-700 rounded-lg font-semibold">
                                    Low
                                </button>
                                <button onclick="gameStates.plinko.risk = 'medium'; renderMainApp()" 
                                    class="px-4 py-3 ${state.risk === 'medium' ? 'bg-yellow-600' : 'bg-gray-700'} hover:bg-yellow-700 rounded-lg font-semibold">
                                    Medium
                                </button>
                                <button onclick="gameStates.plinko.risk = 'high'; renderMainApp()" 
                                    class="px-4 py-3 ${state.risk === 'high' ? 'bg-red-600' : 'bg-gray-700'} hover:bg-red-700 rounded-lg font-semibold">
                                    High
                                </button>
                            </div>
                        </div>
                        <button onclick="dropPlinko()" ${state.loading ? 'disabled' : ''} class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold disabled:opacity-50">
                            ${state.loading ? 'Dropping...' : `Drop Ball - ${(state.bet / 100).toFixed(2)}`}
                        </button>
                    </div>
                </div>
            `;
        }

        async function dropPlinko() {
            gameStates.plinko.loading = true;
            gameStates.plinko.dropping = true;
            renderMainApp();

            try {
                const res = await fetch(`${API_URL}/game/plinko`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: currentUser.username, 
                        bet: gameStates.plinko.bet,
                        risk: gameStates.plinko.risk,
                        isDemo 
                    })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Error dropping ball');
                    gameStates.plinko.loading = false;
                    gameStates.plinko.dropping = false;
                    renderMainApp();
                    return;
                }
                
                setTimeout(() => {
                    gameStates.plinko.result = data;
                    if (data.balance !== undefined) updateBalance(data.balance);
                    gameStates.plinko.loading = false;
                    gameStates.plinko.dropping = false;
                    renderMainApp();
                }, 1500);
            } catch (err) {
                alert('Error: ' + err.message);
                gameStates.plinko.loading = false;
                gameStates.plinko.dropping = false;
                renderMainApp();
            }
        }

        // HI-LO
        function renderHiLo() {
            const state = gameStates.hilo;

            if (!state.gameActive) {
                return `
                    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold mb-6 text-center">üìä Hi-Lo</h2>
                        ${state.gameOver ? `
                            <div class="p-4 rounded-lg text-center text-xl font-bold mb-4 ${state.won ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}">
                                ${state.won ? `Won ${(state.winAmount / 100).toFixed(2)} (${state.multiplier}x)!` : 'You Lost!'}
                            </div>
                        ` : ''}
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Bet Amount ($)</label>
                                <input type="number" value="${state.bet / 100}" min="1" step="1"
                                    onchange="gameStates.hilo.bet = parseInt(this.value * 100)"
                                    class="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white">
                            </div>
                            <button onclick="startHiLo()" ${state.loading ? 'disabled' : ''} class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold disabled:opacity-50">
                                ${state.loading ? 'Starting...' : 'Start Game'}
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold mb-4 text-center">üìä Hi-Lo</h2>
                    <div class="mb-4 text-center">
                        <div class="text-2xl font-bold text-green-400">Multiplier: ${state.multiplier}x</div>
                        <div class="text-lg text-gray-400">Potential Win: ${((state.bet * state.multiplier) / 100).toFixed(2)}</div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-center">Current Card</h3>
                        <div class="flex justify-center">
                            ${renderCard(state.currentCard)}
                        </div>
                    </div>
                    ${state.nextCard ? `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-3 text-center">Next Card</h3>
                            <div class="flex justify-center">
                                ${renderCard(state.nextCard)}
                            </div>
                        </div>
                    ` : ''}
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="guessHiLo('higher')" ${state.loading ? 'disabled' : ''} class="px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold disabled:opacity-50">
                                ‚¨ÜÔ∏è Higher
                            </button>
                            <button onclick="guessHiLo('lower')" ${state.loading ? 'disabled' : ''} class="px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold disabled:opacity-50">
                                ‚¨áÔ∏è Lower
                            </button>
                        </div>
                        <button onclick="cashoutHiLo()" class="w-full px-4 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-semibold">
                            Cash Out - ${((state.bet * state.multiplier) / 100).toFixed(2)}
                        </button>
                    </div>
                </div>
            `;
        }

        async function startHiLo() {
            gameStates.hilo.loading = true;
            gameStates.hilo.multiplier = 1.0;
            gameStates.hilo.gameOver = false;
            gameStates.hilo.nextCard = null;
            renderMainApp();

            try {
                const res = await fetch(`${API_URL}/game/hilo/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: currentUser.username, 
                        bet: gameStates.hilo.bet,
                        isDemo 
                    })
                });
                const data = await res.json();
                
                if (!res.ok) {
                    alert(data.error || 'Error starting game');
                    gameStates.hilo.loading = false;
                    renderMainApp();
                    return;
                }
                
                if (data.balance !== undefined) updateBalance(data.balance);
                gameStates.hilo.currentCard = data.currentCard;
                gameStates.hilo.gameActive = true;
            } catch (err) {
                alert('Error: ' + err.message);
            }
            gameStates.hilo.loading = false;
            renderMainApp();
        }

        async function guessHiLo(direction) {
            gameStates.hilo.loading = true;
            renderMainApp();

            try {
                const res = await fetch(`${API_URL}/game/hilo/guess`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username, direction })
                });
                const data = await res.json();
                
                gameStates.hilo.nextCard = data.nextCard;
                
                if (!data.won) {
                    gameStates.hilo.gameActive = false;
                    gameStates.hilo.gameOver = true;
                    gameStates.hilo.won = false;
                } else if (data.gameOver) {
                    gameStates.hilo.gameActive = false;
                    gameStates.hilo.gameOver = true;
                    gameStates.hilo.won = true;
                    gameStates.hilo.winAmount = data.winAmount;
                    if (data.balance !== undefined) updateBalance(data.balance);
                } else {
                    gameStates.hilo.currentCard = data.nextCard;
                    gameStates.hilo.multiplier = data.multiplier;
                    gameStates.hilo.nextCard = null;
                }
                
                gameStates.hilo.loading = false;
                renderMainApp();
            } catch (err) {
                alert('Error: ' + err.message);
                gameStates.hilo.loading = false;
                renderMainApp();
            }
        }

        async function cashoutHiLo() {
            try {
                const res = await fetch(`${API_URL}/game/hilo/cashout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser.username })
                });
                const data = await res.json();
                
                if (data.balance !== undefined) updateBalance(data.balance);
                gameStates.hilo.gameActive = false;
                gameStates.hilo.gameOver = true;
                gameStates.hilo.won = true;
                gameStates.hilo.winAmount = data.winAmount;
                renderMainApp();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Utility Functions
        function updateBalance(newBalance) {
            if (isDemo) {
                currentUser.freeBalance = newBalance;
            } else {
                currentUser.balance = newBalance;
            }
        }

        function toggleDemo() {
            isDemo = !isDemo;
            renderMainApp();
        }

        function selectGame(gameId) {
            currentGame = gameId;
            renderMainApp();
        }

        function backToGames() {
            currentGame = null;
            renderMainApp();
        }

        function logout() {
            currentUser = null;
            currentGame = null;
            isDemo = false;
            adminLoggedIn = false;
            adminPassword = '';
            showSettings = false;
            renderAuthScreen();
        }

        function showBugReport() {
            document.getElementById('bug-modal').classList.remove('hidden');
        }

        function closeBugReport() {
            document.getElementById('bug-modal').classList.add('hidden');
        }

        async function submitBugReport() {
            const game = document.getElementById('bug-game').value;
            const description = document.getElementById('bug-description').value;

            if (!game || !description) {
                alert('Please select a game and enter a description');
                return;
            }

            try {
                await fetch(`${API_URL}/api/bug-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: currentUser.username, 
                        game, 
                        description 
                    })
                });
                closeBugReport();
                document.getElementById('bug-game').value = '';
                document.getElementById('bug-description').value = '';
                alert('Bug report submitted! You may receive $0.25 if accepted by admin.');
            } catch (err) {
                alert('Failed to submit bug report');
            }
        }

        // Initialize app
        renderAuthScreen();
    </script>
</body>
</html>
