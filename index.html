
import React, { useState, useEffect } from 'react';
import { DollarSign, Trophy, Flame, Zap, Grid3x3, TrendingUp, Coins, Shuffle, Target, Menu, X, Bug, LogOut, User } from 'lucide-react';

const API_URL = 'http://localhost:5000';

const Card = ({ children, className = '' }) => (
  <div className={`bg-gray-800 rounded-lg border border-gray-700 ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, disabled, variant = 'primary', className = '' }) => {
  const variants = {
    primary: 'bg-purple-600 hover:bg-purple-700 disabled:bg-gray-700',
    secondary: 'bg-gray-700 hover:bg-gray-600',
    danger: 'bg-red-600 hover:bg-red-700',
    success: 'bg-green-600 hover:bg-green-700'
  };
  
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={`px-4 py-2 rounded-lg font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed ${variants[variant]} ${className}`}
    >
      {children}
    </button>
  );
};

export default function JudecinoCasino() {
  const [user, setUser] = useState(null);
  const [showAuth, setShowAuth] = useState(true);
  const [isLogin, setIsLogin] = useState(true);
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [currentGame, setCurrentGame] = useState(null);
  const [isDemo, setIsDemo] = useState(false);
  const [showMenu, setShowMenu] = useState(false);
  const [showBugReport, setShowBugReport] = useState(false);
  const [error, setError] = useState('');

  const games = [
    { id: 'blackjack', name: 'Blackjack', icon: 'üÉè', color: 'from-red-500 to-pink-600' },
    { id: 'poker', name: 'Poker', icon: '‚ô†Ô∏è', color: 'from-blue-500 to-cyan-600' },
    { id: 'mines', name: 'Mines', icon: 'üí£', color: 'from-orange-500 to-red-600' },
    { id: 'towers', name: 'Towers', icon: 'üè¢', color: 'from-purple-500 to-pink-600' },
    { id: 'plinko', name: 'Plinko', icon: 'üéØ', color: 'from-yellow-500 to-orange-600' },
    { id: 'roulette', name: 'Roulette', icon: 'üé°', color: 'from-green-500 to-teal-600' },
    { id: 'hilo', name: 'Hi-Lo', icon: 'üìä', color: 'from-indigo-500 to-blue-600' },
    { id: 'coinflip', name: 'Coin Flip', icon: 'ü™ô', color: 'from-gray-500 to-slate-600' }
  ];

  const handleAuth = async () => {
    setError('');
    try {
      const endpoint = isLogin ? '/login' : '/register';
      const res = await fetch(`${API_URL}${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      
      const data = await res.json();
      if (res.ok) {
        setUser(data);
        setShowAuth(false);
      } else {
        setError(data.error);
      }
    } catch (err) {
      setError('Connection failed. Is the server running?');
    }
  };

  const handleLogout = () => {
    setUser(null);
    setShowAuth(true);
    setCurrentGame(null);
    setUsername('');
    setPassword('');
  };

  const submitBugReport = async (game, description) => {
    try {
      await fetch(`${API_URL}/api/bug-report`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username, game, description })
      });
      setShowBugReport(false);
      alert('Bug report submitted! You may receive $0.25 if accepted.');
    } catch (err) {
      alert('Failed to submit bug report');
    }
  };

  if (showAuth) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 flex items-center justify-center p-4">
        <Card className="w-full max-w-md p-8">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-2">
              üé∞ Judeceno Casino
            </h1>
            <p className="text-gray-400">Your Premium Gaming Destination</p>
          </div>

          {error && (
            <div className="bg-red-500/20 border border-red-500 rounded-lg p-3 mb-4 text-red-300 text-sm">
              {error}
            </div>
          )}

          <div className="space-y-4">
            <input
              type="text"
              placeholder="Username"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              className="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
              onKeyPress={(e) => e.key === 'Enter' && handleAuth()}
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-purple-500"
              onKeyPress={(e) => e.key === 'Enter' && handleAuth()}
            />
            <Button onClick={handleAuth} className="w-full py-3">
              {isLogin ? 'Login' : 'Register'}
            </Button>
            <button
              onClick={() => setIsLogin(!isLogin)}
              className="w-full text-purple-400 hover:text-purple-300 text-sm"
            >
              {isLogin ? "Don't have an account? Register" : 'Already have an account? Login'}
            </button>
          </div>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white">
      {/* Header */}
      <div className="bg-gray-800/50 backdrop-blur-sm border-b border-gray-700 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <button onClick={() => setShowMenu(!showMenu)} className="lg:hidden">
                {showMenu ? <X size={24} /> : <Menu size={24} />}
              </button>
              <h1 className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                üé∞ Judeceno
              </h1>
            </div>
            
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2 bg-gray-900 px-4 py-2 rounded-lg">
                <span className="text-sm text-gray-400">Mode:</span>
                <button
                  onClick={() => setIsDemo(!isDemo)}
                  className={`px-3 py-1 rounded text-sm font-semibold ${
                    isDemo ? 'bg-yellow-600' : 'bg-green-600'
                  }`}
                >
                  {isDemo ? 'üéÅ Demo' : 'üí∞ Real'}
                </button>
              </div>
              
              <div className="bg-gray-900 px-4 py-2 rounded-lg">
                <div className="flex items-center gap-2">
                  <DollarSign size={18} className="text-green-400" />
                  <span className="font-bold">
                    ${((isDemo ? user.freeBalance : user.balance) / 100).toFixed(2)}
                  </span>
                </div>
              </div>

              <button
                onClick={() => setShowBugReport(true)}
                className="p-2 bg-gray-900 rounded-lg hover:bg-gray-700 transition-colors"
                title="Report Bug"
              >
                <Bug size={20} />
              </button>

              <button
                onClick={handleLogout}
                className="p-2 bg-gray-900 rounded-lg hover:bg-red-700 transition-colors"
                title="Logout"
              >
                <LogOut size={20} />
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto px-4 py-8">
        {!currentGame ? (
          <>
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold mb-2">Welcome, {user.username}! üéâ</h2>
              <p className="text-gray-400">Choose your game and let's win big!</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {games.map((game) => (
                <button
                  key={game.id}
                  onClick={() => setCurrentGame(game.id)}
                  className="group relative overflow-hidden rounded-xl bg-gradient-to-br from-gray-800 to-gray-900 p-6 transition-all hover:scale-105 hover:shadow-2xl hover:shadow-purple-500/20"
                >
                  <div className={`absolute inset-0 bg-gradient-to-br ${game.color} opacity-0 group-hover:opacity-10 transition-opacity`} />
                  <div className="relative">
                    <div className="text-5xl mb-3">{game.icon}</div>
                    <h3 className="text-xl font-bold mb-1">{game.name}</h3>
                    <p className="text-gray-400 text-sm">Click to play</p>
                  </div>
                </button>
              ))}
            </div>
          </>
        ) : (
          <GameView
            game={currentGame}
            user={user}
            isDemo={isDemo}
            onBack={() => setCurrentGame(null)}
            onBalanceUpdate={(newBalance) => {
              setUser({
                ...user,
                [isDemo ? 'freeBalance' : 'balance']: newBalance
              });
            }}
          />
        )}
      </div>

      {/* Bug Report Modal */}
      {showBugReport && (
        <BugReportModal
          username={user.username}
          onClose={() => setShowBugReport(false)}
          onSubmit={submitBugReport}
        />
      )}
    </div>
  );
}

function BugReportModal({ username, onClose, onSubmit }) {
  const [game, setGame] = useState('');
  const [description, setDescription] = useState('');

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <Card className="w-full max-w-md p-6">
        <h3 className="text-2xl font-bold mb-4">üêõ Report a Bug</h3>
        <div className="space-y-4">
          <select
            value={game}
            onChange={(e) => setGame(e.target.value)}
            className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
          >
            <option value="">Select Game</option>
            <option value="blackjack">Blackjack</option>
            <option value="poker">Poker</option>
            <option value="mines">Mines</option>
            <option value="towers">Towers</option>
            <option value="plinko">Plinko</option>
            <option value="roulette">Roulette</option>
            <option value="hilo">Hi-Lo</option>
            <option value="coinflip">Coin Flip</option>
          </select>
          <textarea
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            placeholder="Describe the bug..."
            className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white h-32 resize-none"
          />
          <div className="flex gap-2">
            <Button onClick={() => onSubmit(game, description)} disabled={!game || !description}>
              Submit Report
            </Button>
            <Button onClick={onClose} variant="secondary">
              Cancel
            </Button>
          </div>
        </div>
      </Card>
    </div>
  );
}

function GameView({ game, user, isDemo, onBack, onBalanceUpdate }) {
  const gameComponents = {
    blackjack: BlackjackGame,
    poker: PokerGame,
    mines: MinesGame,
    towers: TowersGame,
    plinko: PlinkoGame,
    roulette: RouletteGame,
    hilo: HiLoGame,
    coinflip: CoinFlipGame
  };

  const GameComponent = gameComponents[game];

  return (
    <div>
      <button
        onClick={onBack}
        className="mb-4 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors"
      >
        ‚Üê Back to Games
      </button>
      <GameComponent user={user} isDemo={isDemo} onBalanceUpdate={onBalanceUpdate} />
    </div>
  );
}

// BLACKJACK GAME
function BlackjackGame({ user, isDemo, onBalanceUpdate }) {
  const [bet, setBet] = useState(100);
  const [gameState, setGameState] = useState(null);
  const [loading, setLoading] = useState(false);

  const deal = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/blackjack/deal`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username, bet, isDemo })
      });
      const data = await res.json();
      setGameState(data);
      if (data.balance !== undefined) onBalanceUpdate(data.balance);
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const hit = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/blackjack/hit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username })
      });
      const data = await res.json();
      setGameState({ ...gameState, ...data });
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const stand = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/blackjack/stand`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username })
      });
      const data = await res.json();
      setGameState({ ...gameState, ...data });
      if (data.balance !== undefined) onBalanceUpdate(data.balance);
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const renderCard = (card) => {
    if (!card) return <div className="w-20 h-28 bg-purple-600 rounded-lg border-2 border-white/20" />;
    const suitSymbols = { hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£', spades: '‚ô†' };
    return (
      <div className={`w-20 h-28 bg-white rounded-lg border-2 flex flex-col items-center justify-center ${card.color === 'red' ? 'text-red-600' : 'text-black'}`}>
        <div className="text-2xl font-bold">{card.value}</div>
        <div className="text-3xl">{suitSymbols[card.suit]}</div>
      </div>
    );
  };

  return (
    <Card className="p-6">
      <h2 className="text-3xl font-bold mb-6 text-center">üÉè Blackjack</h2>

      {!gameState || gameState.result ? (
        <div className="space-y-4">
          {gameState?.result && (
            <div className={`p-4 rounded-lg text-center text-xl font-bold ${
              gameState.result.win > 0 ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'
            }`}>
              {gameState.result.message} {gameState.result.win > 0 && `- Won $${(gameState.result.win / 100).toFixed(2)}!`}
            </div>
          )}
          
          <div>
            <label className="block text-sm text-gray-400 mb-2">Bet Amount</label>
            <input
              type="number"
              value={bet}
              onChange={(e) => setBet(Math.max(100, parseInt(e.target.value) || 100))}
              className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
              min="100"
              step="100"
            />
          </div>
          
          <Button onClick={deal} disabled={loading} className="w-full py-3">
            Deal Cards - ${(bet / 100).toFixed(2)}
          </Button>
        </div>
      ) : (
        <div className="space-y-6">
          <div>
            <h3 className="text-lg font-semibold mb-3 text-center">Dealer's Hand</h3>
            <div className="flex gap-2 justify-center">
              {gameState.dealerHand.map((card, i) => (
                <div key={i}>{renderCard(card)}</div>
              ))}
            </div>
            {gameState.dealerScore && (
              <div className="text-center mt-2 text-xl font-bold">Score: {gameState.dealerScore}</div>
            )}
          </div>

          <div>
            <h3 className="text-lg font-semibold mb-3 text-center">Your Hand</h3>
            <div className="flex gap-2 justify-center">
              {gameState.playerHand.map((card, i) => (
                <div key={i}>{renderCard(card)}</div>
              ))}
            </div>
            <div className="text-center mt-2 text-xl font-bold">Score: {gameState.playerScore}</div>
          </div>

          <div className="flex gap-2">
            <Button onClick={hit} disabled={loading} className="flex-1">
              Hit
            </Button>
            <Button onClick={stand} disabled={loading} variant="secondary" className="flex-1">
              Stand
            </Button>
          </div>
        </div>
      )}
    </Card>
  );
}

// POKER GAME
function PokerGame({ user, isDemo, onBalanceUpdate }) {
  const [bet, setBet] = useState(100);
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);

  const play = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/poker/deal`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username, bet, isDemo })
      });
      const data = await res.json();
      setResult(data);
      if (data.balance !== undefined) onBalanceUpdate(data.balance);
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const renderCard = (card) => {
    const suitSymbols = { hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£', spades: '‚ô†' };
    return (
      <div className={`w-20 h-28 bg-white rounded-lg border-2 flex flex-col items-center justify-center ${card.color === 'red' ? 'text-red-600' : 'text-black'}`}>
        <div className="text-2xl font-bold">{card.value}</div>
        <div className="text-3xl">{suitSymbols[card.suit]}</div>
      </div>
    );
  };

  return (
    <Card className="p-6">
      <h2 className="text-3xl font-bold mb-6 text-center">‚ô†Ô∏è Three Card Poker</h2>

      <div className="space-y-4">
        {result && (
          <>
            <div className={`p-4 rounded-lg text-center text-xl font-bold ${
              result.result.win > 0 ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'
            }`}>
              {result.result.message} {result.result.win > 0 && `- Won $${(result.result.win / 100).toFixed(2)}!`}
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <h3 className="text-lg font-semibold mb-3 text-center">Your Hand</h3>
                <div className="flex gap-2 justify-center">
                  {result.playerHand.map((card, i) => (
                    <div key={i}>{renderCard(card)}</div>
                  ))}
                </div>
              </div>
              <div>
                <h3 className="text-lg font-semibold mb-3 text-center">Dealer's Hand</h3>
                <div className="flex gap-2 justify-center">
                  {result.dealerHand.map((card, i) => (
                    <div key={i}>{renderCard(card)}</div>
                  ))}
                </div>
              </div>
            </div>
          </>
        )}

        <div>
          <label className="block text-sm text-gray-400 mb-2">Bet Amount</label>
          <input
            type="number"
            value={bet}
            onChange={(e) => setBet(Math.max(100, parseInt(e.target.value) || 100))}
            className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
            min="100"
            step="100"
          />
        </div>

        <Button onClick={play} disabled={loading} className="w-full py-3">
          {result ? 'Play Again' : 'Play'} - ${(bet / 100).toFixed(2)}
        </Button>
      </div>
    </Card>
  );
}

// MINES GAME
function MinesGame({ user, isDemo, onBalanceUpdate }) {
  const [bet, setBet] = useState(100);
  const [mineCount, setMineCount] = useState(5);
  const [gameActive, setGameActive] = useState(false);
  const [revealed, setRevealed] = useState([]);
  const [multiplier, setMultiplier] = useState(1.0);
  const [gameOver, setGameOver] = useState(false);
  const [loading, setLoading] = useState(false);

  const startGame = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/mines/start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username, bet, mineCount, isDemo })
      });
      const data = await res.json();
      if (res.ok) {
        setGameActive(true);
        setRevealed([]);
        setMultiplier(1.0);
        setGameOver(false);
        if (data.balance !== undefined) onBalanceUpdate(data.balance);
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const revealTile = async (index) => {
    if (revealed.includes(index) || gameOver || loading) return;
    
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/mines/reveal`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username, index })
      });
      const data = await res.json();
      
      if (data.result.hit === 'mine') {
        setRevealed([...revealed, index]);
        setGameOver(true);
        setGameActive(false);
      } else {
        setRevealed([...revealed, index]);
        setMultiplier(data.result.multiplier);
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const cashout = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/mines/cashout`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username })
      });
      const data = await res.json();
      if (data.balance !== undefined) onBalanceUpdate(data.balance);
      alert(`Cashed out $${(data.winAmount / 100).toFixed(2)}!`);
      setGameActive(false);
      setGameOver(true);
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  return (
    <Card className="p-6">
      <h2 className="text-3xl font-bold mb-6 text-center">üí£ Mines</h2>

      {!gameActive ? (
        <div className="space-y-4">
          <div>
            <label className="block text-sm text-gray-400 mb-2">Bet Amount</label>
            <input
              type="number"
              value={bet}
              onChange={(e) => setBet(Math.max(100, parseInt(e.target.value) || 100))}
              className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
              min="100"
              step="100"
            />
          </div>

          <div>
            <label className="block text-sm text-gray-400 mb-2">Number of Mines (1-24)</label>
            <input
              type="number"
              value={mineCount}
              onChange={(e) => setMineCount(Math.max(1, Math.min(24, parseInt(e.target.value) || 5)))}
              className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
              min="1"
              max="24"
            />
          </div>

          <Button onClick={startGame} disabled={loading} className="w-full py-3">
            Start Game - ${(bet / 100).toFixed(2)}
          </Button>
        </div>
      ) : (
        <div className="space-y-4">
          <div className="flex justify-between items-center p-4 bg-gray-900 rounded-lg">
            <div>
              <div className="text-sm text-gray-400">Multiplier</div>
              <div className="text-2xl font-bold text-green-400">{multiplier.toFixed(2)}x</div>
            </div>
            <div>
              <div className="text-sm text-gray-400">Potential Win</div>
              <div className="text-2xl font-bold">${((bet * multiplier) / 100).toFixed(2)}</div>
            </div>
          </div>

          <div className="grid grid-cols-5 gap-2">
            {[...Array(25)].map((_, i) => (
              <button
                key={i}
                onClick={() => revealTile(i)}
                disabled={revealed.includes(i) || gameOver}
                className={`aspect-square rounded-lg text-2xl font-bold transition-all ${
                  revealed.includes(i)
                    ? 'bg-green-500 text-white'
                    : 'bg-gray-700 hover:bg-gray-600'
                } disabled:opacity-50`}
              >
                {revealed.includes(i) ? 'üíé' : '?'}
              </button>
            ))}
          </div>

          {!gameOver && revealed.length > 0 && (
            <Button onClick={cashout} disabled={loading} variant="success" className="w-full py-3">
              Cashout ${((bet * multiplier) / 100).toFixed(2)}
            </Button>
          )}

          {gameOver && (
            <Button onClick={() => { setGameActive(false); setRevealed([]); }} className="w-full py-3">
              New Game
            </Button>
          )}
        </div>
      )}
    </Card>
  );
}

// COIN FLIP GAME
function CoinFlipGame({ user, isDemo, onBalanceUpdate }) {
  const [bet, setBet] = useState(100);
  const [choice, setChoice] = useState('heads');
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [flipping, setFlipping] = useState(false);

  const flip = async () => {
    setLoading(true);
    setFlipping(true);
    setResult(null);
    
    setTimeout(async () => {
      try {
        const res = await fetch(`${API_URL}/game/coinflip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user.username, bet, choice, isDemo })
        });
        const data = await res.json();
        setResult(data);
        if (data.balance !== undefined) onBalanceUpdate(data.balance);
        setFlipping(false);
      } catch (err) {
        alert('Error: ' + err.message);
        setFlipping(false);
      }
      setLoading(false);
    }, 1500);
  };

  return (
    <Card className="p-6">
      <h2 className="text-3xl font-bold mb-6 text-center">ü™ô Coin Flip</h2>

      <div className="space-y-6">
        {result && !flipping && (
          <div className={`p-4 rounded-lg text-center text-xl font-bold ${
            result.isWin ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'
          }`}>
            {result.outcome.toUpperCase()} - {result.isWin ? `Won ${(result.winAmount / 100).toFixed(2)}!` : 'Better luck next time!'}
          </div>
        )}

        <div className="flex justify-center">
          <div className={`w-32 h-32 rounded-full flex items-center justify-center text-6xl ${
            flipping ? 'animate-spin' : ''
          } ${result ? (result.outcome === 'heads' ? 'bg-yellow-500' : 'bg-gray-400') : 'bg-purple-600'}`}>
            {flipping ? 'ü™ô' : result ? (result.outcome === 'heads' ? 'üëë' : '‚ö°') : 'ü™ô'}
          </div>
        </div>

        <div className="flex gap-4">
          <button
            onClick={() => setChoice('heads')}
            className={`flex-1 py-4 rounded-lg font-bold transition-all ${
              choice === 'heads' ? 'bg-yellow-600' : 'bg-gray-700 hover:bg-gray-600'
            }`}
          >
            üëë Heads
          </button>
          <button
            onClick={() => setChoice('tails')}
            className={`flex-1 py-4 rounded-lg font-bold transition-all ${
              choice === 'tails' ? 'bg-gray-500' : 'bg-gray-700 hover:bg-gray-600'
            }`}
          >
            ‚ö° Tails
          </button>
        </div>

        <div>
          <label className="block text-sm text-gray-400 mb-2">Bet Amount</label>
          <input
            type="number"
            value={bet}
            onChange={(e) => setBet(Math.max(100, parseInt(e.target.value) || 100))}
            className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
            min="100"
            step="100"
          />
        </div>

        <Button onClick={flip} disabled={loading} className="w-full py-3">
          Flip Coin - ${(bet / 100).toFixed(2)}
        </Button>
      </div>
    </Card>
  );
}

// ROULETTE GAME
function RouletteGame({ user, isDemo, onBalanceUpdate }) {
  const [bet, setBet] = useState(100);
  const [betType, setBetType] = useState('red');
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [spinning, setSpinning] = useState(false);

  const spin = async () => {
    setLoading(true);
    setSpinning(true);
    setResult(null);
    
    setTimeout(async () => {
      try {
        const res = await fetch(`${API_URL}/game/roulette`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user.username, bet, betType, isDemo })
        });
        const data = await res.json();
        setResult(data);
        if (data.balance !== undefined) onBalanceUpdate(data.balance);
        setSpinning(false);
      } catch (err) {
        alert('Error: ' + err.message);
        setSpinning(false);
      }
      setLoading(false);
    }, 2000);
  };

  const getNumberColor = (num) => {
    if (num === 0) return 'green';
    const reds = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
    return reds.includes(num) ? 'red' : 'black';
  };

  return (
    <Card className="p-6">
      <h2 className="text-3xl font-bold mb-6 text-center">üé° Roulette</h2>

      <div className="space-y-6">
        {result && !spinning && (
          <div className={`p-6 rounded-lg text-center ${
            result.isWin ? 'bg-green-500/20' : 'bg-red-500/20'
          }`}>
            <div className="text-4xl font-bold mb-2">{result.outcome}</div>
            <div className={`text-lg font-semibold ${
              result.isWin ? 'text-green-300' : 'text-red-300'
            }`}>
              {result.isWin ? `Won ${(result.winAmount / 100).toFixed(2)}!` : 'Try again!'}
            </div>
          </div>
        )}

        <div className="flex justify-center">
          <div className={`w-40 h-40 rounded-full flex items-center justify-center text-6xl border-4 ${
            spinning ? 'animate-spin border-purple-500' : 'border-gray-600'
          } ${
            result ? (
              getNumberColor(result.outcome) === 'green' ? 'bg-green-600' :
              getNumberColor(result.outcome) === 'red' ? 'bg-red-600' : 'bg-gray-900'
            ) : 'bg-purple-900'
          }`}>
            {spinning ? 'üé∞' : result ? result.outcome : 'üé°'}
          </div>
        </div>

        <div className="grid grid-cols-3 gap-2">
          <button
            onClick={() => setBetType('red')}
            className={`py-3 rounded-lg font-bold ${
              betType === 'red' ? 'bg-red-600' : 'bg-gray-700 hover:bg-red-700'
            }`}
          >
            üî¥ Red (2x)
          </button>
          <button
            onClick={() => setBetType('black')}
            className={`py-3 rounded-lg font-bold ${
              betType === 'black' ? 'bg-gray-900 border-2 border-white' : 'bg-gray-700 hover:bg-gray-900'
            }`}
          >
            ‚ö´ Black (2x)
          </button>
          <button
            onClick={() => setBetType('green')}
            className={`py-3 rounded-lg font-bold ${
              betType === 'green' ? 'bg-green-600' : 'bg-gray-700 hover:bg-green-700'
            }`}
          >
            üü¢ Green (36x)
          </button>
          <button
            onClick={() => setBetType('even')}
            className={`py-3 rounded-lg font-bold ${
              betType === 'even' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-blue-700'
            }`}
          >
            Even (2x)
          </button>
          <button
            onClick={() => setBetType('odd')}
            className={`py-3 rounded-lg font-bold ${
              betType === 'odd' ? 'bg-purple-600' : 'bg-gray-700 hover:bg-purple-700'
            }`}
          >
            Odd (2x)
          </button>
        </div>

        <div>
          <label className="block text-sm text-gray-400 mb-2">Bet Amount</label>
          <input
            type="number"
            value={bet}
            onChange={(e) => setBet(Math.max(100, parseInt(e.target.value) || 100))}
            className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
            min="100"
            step="100"
          />
        </div>

        <Button onClick={spin} disabled={loading} className="w-full py-3">
          Spin - ${(bet / 100).toFixed(2)}
        </Button>
      </div>
    </Card>
  );
}

// TOWERS GAME
function TowersGame({ user, isDemo, onBalanceUpdate }) {
  const [bet, setBet] = useState(100);
  const [difficulty, setDifficulty] = useState('easy');
  const [gameActive, setGameActive] = useState(false);
  const [currentRow, setCurrentRow] = useState(0);
  const [revealed, setRevealed] = useState([]);
  const [gameOver, setGameOver] = useState(false);
  const [loading, setLoading] = useState(false);
  const [multiplier, setMultiplier] = useState(1.0);

  const startGame = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/towers/start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username, bet, difficulty, isDemo })
      });
      const data = await res.json();
      if (res.ok) {
        setGameActive(true);
        setCurrentRow(0);
        setRevealed([]);
        setGameOver(false);
        setMultiplier(1.0);
        if (data.balance !== undefined) onBalanceUpdate(data.balance);
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const pickTile = async (row, col) => {
    if (row !== currentRow || gameOver || loading) return;
    
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/towers/pick`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username, row, col })
      });
      const data = await res.json();
      
      if (data.isBomb) {
        setRevealed([...revealed, { row, col, bomb: true }]);
        setGameOver(true);
        setGameActive(false);
      } else {
        setRevealed([...revealed, { row, col, bomb: false }]);
        if (data.gameOver) {
          setGameOver(true);
          setGameActive(false);
          if (data.balance !== undefined) onBalanceUpdate(data.balance);
          alert(`You won ${(data.winAmount / 100).toFixed(2)}!`);
        } else {
          setCurrentRow(data.currentRow);
          setMultiplier(data.multiplier);
        }
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const cashout = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/towers/cashout`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username })
      });
      const data = await res.json();
      if (data.balance !== undefined) onBalanceUpdate(data.balance);
      alert(`Cashed out ${(data.winAmount / 100).toFixed(2)}!`);
      setGameActive(false);
      setGameOver(true);
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const getTileState = (row, col) => {
    const tile = revealed.find(r => r.row === row && r.col === col);
    if (tile) return tile.bomb ? 'bomb' : 'safe';
    return 'hidden';
  };

  return (
    <Card className="p-6">
      <h2 className="text-3xl font-bold mb-6 text-center">üè¢ Towers</h2>

      {!gameActive ? (
        <div className="space-y-4">
          <div>
            <label className="block text-sm text-gray-400 mb-2">Difficulty</label>
            <div className="flex gap-2">
              <button
                onClick={() => setDifficulty('easy')}
                className={`flex-1 py-2 rounded-lg font-bold ${
                  difficulty === 'easy' ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'
                }`}
              >
                Easy (1 bomb)
              </button>
              <button
                onClick={() => setDifficulty('hard')}
                className={`flex-1 py-2 rounded-lg font-bold ${
                  difficulty === 'hard' ? 'bg-red-600' : 'bg-gray-700 hover:bg-gray-600'
                }`}
              >
                Hard (2 bombs)
              </button>
            </div>
          </div>

          <div>
            <label className="block text-sm text-gray-400 mb-2">Bet Amount</label>
            <input
              type="number"
              value={bet}
              onChange={(e) => setBet(Math.max(100, parseInt(e.target.value) || 100))}
              className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
              min="100"
              step="100"
            />
          </div>

          <Button onClick={startGame} disabled={loading} className="w-full py-3">
            Start Game - ${(bet / 100).toFixed(2)}
          </Button>
        </div>
      ) : (
        <div className="space-y-4">
          <div className="flex justify-between items-center p-4 bg-gray-900 rounded-lg">
            <div>
              <div className="text-sm text-gray-400">Row {currentRow + 1}/8</div>
              <div className="text-2xl font-bold text-green-400">{multiplier.toFixed(2)}x</div>
            </div>
            <div>
              <div className="text-sm text-gray-400">Potential Win</div>
              <div className="text-2xl font-bold">${((bet * multiplier) / 100).toFixed(2)}</div>
            </div>
          </div>

          <div className="space-y-2">
            {[...Array(8)].map((_, row) => (
              <div key={row} className="flex gap-2">
                {[...Array(3)].map((_, col) => {
                  const state = getTileState(7 - row, col);
                  return (
                    <button
                      key={col}
                      onClick={() => pickTile(7 - row, col)}
                      disabled={7 - row !== currentRow || gameOver}
                      className={`flex-1 h-16 rounded-lg text-2xl font-bold transition-all ${
                        state === 'safe' ? 'bg-green-500 text-white' :
                        state === 'bomb' ? 'bg-red-500 text-white' :
                        7 - row === currentRow ? 'bg-gray-700 hover:bg-gray-600' :
                        'bg-gray-800'
                      } disabled:opacity-50`}
                    >
                      {state === 'safe' ? 'üíé' : state === 'bomb' ? 'üí£' : '?'}
                    </button>
                  );
                })}
              </div>
            ))}
          </div>

          {!gameOver && currentRow > 0 && (
            <Button onClick={cashout} disabled={loading} variant="success" className="w-full py-3">
              Cashout ${((bet * multiplier) / 100).toFixed(2)}
            </Button>
          )}

          {gameOver && (
            <Button onClick={() => { setGameActive(false); setRevealed([]); }} className="w-full py-3">
              New Game
            </Button>
          )}
        </div>
      )}
    </Card>
  );
}

// PLINKO GAME
function PlinkoGame({ user, isDemo, onBalanceUpdate }) {
  const [bet, setBet] = useState(100);
  const [risk, setRisk] = useState('medium');
  const [result, setResult] = useState(null);
  const [loading, setLoading] = useState(false);
  const [dropping, setDropping] = useState(false);

  const drop = async () => {
    setLoading(true);
    setDropping(true);
    setResult(null);
    
    setTimeout(async () => {
      try {
        const res = await fetch(`${API_URL}/game/plinko`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user.username, bet, risk, isDemo })
        });
        const data = await res.json();
        setResult(data);
        if (data.balance !== undefined) onBalanceUpdate(data.balance);
        setDropping(false);
      } catch (err) {
        alert('Error: ' + err.message);
        setDropping(false);
      }
      setLoading(false);
    }, 1500);
  };

  const multipliers = {
    high: [80, 20, 5, 2, 0.4, 0.2, 0.2, 0.2, 0.4, 2, 5, 20, 80],
    medium: [20, 8, 4, 2, 0.5, 0.3, 0.3, 0.3, 0.5, 2, 4, 8, 20],
    low: [8, 4, 2, 1.2, 1, 0.7, 0.7, 0.7, 1, 1.2, 2, 4, 8]
  };

  return (
    <Card className="p-6">
      <h2 className="text-3xl font-bold mb-6 text-center">üéØ Plinko</h2>

      <div className="space-y-6">
        {result && !dropping && (
          <div className={`p-4 rounded-lg text-center ${
            result.multiplier >= 1 ? 'bg-green-500/20' : 'bg-red-500/20'
          }`}>
            <div className="text-2xl font-bold mb-2">
              Slot {result.slot} - {result.multiplier}x
            </div>
            <div className={`text-xl font-semibold ${
              result.multiplier >= 1 ? 'text-green-300' : 'text-red-300'
            }`}>
              {result.winAmount > 0 ? `Won ${(result.winAmount / 100).toFixed(2)}!` : 'Try again!'}
            </div>
          </div>
        )}

        <div className="flex justify-center">
          <div className={`w-64 h-64 bg-gray-900 rounded-lg flex items-center justify-center text-6xl ${
            dropping ? 'animate-bounce' : ''
          }`}>
            {dropping ? '‚ö™' : result ? 'üéØ' : 'üé≤'}
          </div>
        </div>

        <div className="grid grid-cols-13 gap-1 text-center text-xs">
          {multipliers[risk].map((mult, i) => (
            <div
              key={i}
              className={`py-1 rounded ${
                mult >= 10 ? 'bg-green-600' :
                mult >= 2 ? 'bg-yellow-600' :
                mult >= 1 ? 'bg-blue-600' :
                'bg-red-600'
              } ${result && result.slot === i ? 'ring-2 ring-white' : ''}`}
            >
              {mult}x
            </div>
          ))}
        </div>

        <div>
          <label className="block text-sm text-gray-400 mb-2">Risk Level</label>
          <div className="flex gap-2">
            <button
              onClick={() => setRisk('low')}
              className={`flex-1 py-2 rounded-lg font-bold ${
                risk === 'low' ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'
              }`}
            >
              Low
            </button>
            <button
              onClick={() => setRisk('medium')}
              className={`flex-1 py-2 rounded-lg font-bold ${
                risk === 'medium' ? 'bg-yellow-600' : 'bg-gray-700 hover:bg-gray-600'
              }`}
            >
              Medium
            </button>
            <button
              onClick={() => setRisk('high')}
              className={`flex-1 py-2 rounded-lg font-bold ${
                risk === 'high' ? 'bg-red-600' : 'bg-gray-700 hover:bg-gray-600'
              }`}
            >
              High
            </button>
          </div>
        </div>

        <div>
          <label className="block text-sm text-gray-400 mb-2">Bet Amount</label>
          <input
            type="number"
            value={bet}
            onChange={(e) => setBet(Math.max(100, parseInt(e.target.value) || 100))}
            className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
            min="100"
            step="100"
          />
        </div>

        <Button onClick={drop} disabled={loading} className="w-full py-3">
          Drop Ball - ${(bet / 100).toFixed(2)}
        </Button>
      </div>
    </Card>
  );
}

// HI-LO GAME
function HiLoGame({ user, isDemo, onBalanceUpdate }) {
  const [bet, setBet] = useState(100);
  const [gameActive, setGameActive] = useState(false);
  const [currentCard, setCurrentCard] = useState(null);
  const [nextCard, setNextCard] = useState(null);
  const [multiplier, setMultiplier] = useState(1.0);
  const [gameOver, setGameOver] = useState(false);
  const [loading, setLoading] = useState(false);

  const startGame = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/hilo/start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username, bet, isDemo })
      });
      const data = await res.json();
      setCurrentCard(data.currentCard);
      setGameActive(true);
      setMultiplier(1.0);
      setGameOver(false);
      setNextCard(null);
      if (data.balance !== undefined) onBalanceUpdate(data.balance);
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const guess = async (direction) => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/hilo/guess`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username, direction })
      });
      const data = await res.json();
      setNextCard(data.nextCard);
      
      if (data.gameOver) {
        setGameOver(true);
        setGameActive(false);
        if (data.balance !== undefined) onBalanceUpdate(data.balance);
        if (data.won) {
          setTimeout(() => alert(`You won ${(data.winAmount / 100).toFixed(2)}!`), 500);
        }
      } else {
        setMultiplier(data.multiplier);
        setTimeout(() => {
          setCurrentCard(data.nextCard);
          setNextCard(null);
        }, 1000);
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const cashout = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/game/hilo/cashout`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: user.username })
      });
      const data = await res.json();
      if (data.balance !== undefined) onBalanceUpdate(data.balance);
      alert(`Cashed out ${(data.winAmount / 100).toFixed(2)}!`);
      setGameActive(false);
      setGameOver(true);
    } catch (err) {
      alert('Error: ' + err.message);
    }
    setLoading(false);
  };

  const renderCard = (card) => {
    if (!card) return null;
    const suitSymbols = { hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£', spades: '‚ô†' };
    return (
      <div className={`w-24 h-32 bg-white rounded-lg border-2 flex flex-col items-center justify-center ${
        card.color === 'red' ? 'text-red-600' : 'text-black'
      }`}>
        <div className="text-3xl font-bold">{card.value}</div>
        <div className="text-4xl">{suitSymbols[card.suit]}</div>
      </div>
    );
  };

  return (
    <Card className="p-6">
      <h2 className="text-3xl font-bold mb-6 text-center">üìä Hi-Lo</h2>

      {!gameActive ? (
        <div className="space-y-4">
          <div>
            <label className="block text-sm text-gray-400 mb-2">Bet Amount</label>
            <input
              type="number"
              value={bet}
              onChange={(e) => setBet(Math.max(100, parseInt(e.target.value) || 100))}
              className="w-full px-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
              min="100"
              step="100"
            />
          </div>

          <Button onClick={startGame} disabled={loading} className="w-full py-3">
            Start Game - ${(bet / 100).toFixed(2)}
          </Button>
        </div>
      ) : (
        <div className="space-y-6">
          <div className="flex justify-between items-center p-4 bg-gray-900 rounded-lg">
            <div>
              <div className="text-sm text-gray-400">Multiplier</div>
              <div className="text-2xl font-bold text-green-400">{multiplier.toFixed(2)}x</div>
            </div>
            <div>
              <div className="text-sm text-gray-400">Potential Win</div>
              <div className="text-2xl font-bold">${((bet * multiplier) / 100).toFixed(2)}</div>
            </div>
          </div>

          <div className="flex justify-center gap-4">
            {renderCard(currentCard)}
            {nextCard && (
              <div className="animate-pulse">
                {renderCard(nextCard)}
              </div>
            )}
          </div>

          {!gameOver && !nextCard && (
            <>
              <div className="flex gap-2">
                <Button onClick={() => guess('higher')} disabled={loading} className="flex-1 py-3">
                  ‚¨ÜÔ∏è Higher
                </Button>
                <Button onClick={() => guess('lower')} disabled={loading} className="flex-1 py-3">
                  ‚¨áÔ∏è Lower
                </Button>
              </div>

              {multiplier > 1 && (
                <Button onClick={cashout} disabled={loading} variant="success" className="w-full py-3">
                  Cashout ${((bet * multiplier) / 100).toFixed(2)}
                </Button>
              )}
            </>
          )}

          {gameOver && (
            <Button onClick={() => { setGameActive(false); setCurrentCard(null); }} className="w-full py-3">
              New Game
            </Button>
          )}
        </div>
      )}
    </Card>
  );
}
