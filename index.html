<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üêÜ Merle Cam Dashboard</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
  color: #f6e0b2;
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
}

.header {
  background: #2a1a0a;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  border: 2px solid #d4a23c;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  display: flex;
  align-items: center;
  gap: 15px;
}

.logo-icon {
  font-size: 48px;
}

.logo-text h1 {
  font-size: 32px;
  color: #d4a23c;
}

.status {
  display: flex;
  gap: 15px;
  align-items: center;
}

.status-badge {
  background: rgba(0, 0, 0, 0.5);
  padding: 10px 20px;
  border-radius: 20px;
  border: 2px solid #d4a23c;
}

.status-dot {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #4ade80;
  margin-right: 8px;
  animation: pulse 2s infinite;
}

.status-dot.error {
  background: #f87171;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.main-grid {
  display: grid;
  grid-template-columns: 1fr 350px;
  gap: 20px;
}

.video-section {
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  border: 3px solid #d4a23c;
  box-shadow: 0 0 30px rgba(212, 162, 60, 0.3);
}

.video-section img {
  width: 100%;
  display: block;
  min-height: 480px;
  background: #1a1a1a;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-top: 20px;
}

.stat-card {
  background: #2a1a0a;
  padding: 20px;
  border-radius: 10px;
  border: 2px solid #d4a23c;
  text-align: center;
}

.stat-card h3 {
  font-size: 12px;
  color: #d4a23c;
  text-transform: uppercase;
  margin-bottom: 10px;
}

.stat-value {
  font-size: 36px;
  font-weight: bold;
  color: #f6e0b2;
}

.stat-label {
  font-size: 11px;
  color: #c4a872;
  margin-top: 5px;
}

.sidebar {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.panel {
  background: #2a1a0a;
  padding: 20px;
  border-radius: 12px;
  border: 2px solid #d4a23c;
}

.panel h2 {
  font-size: 18px;
  color: #d4a23c;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.chat-messages {
  height: 300px;
  overflow-y: auto;
  margin-bottom: 15px;
  background: #1a1a1a;
  padding: 10px;
  border-radius: 8px;
}

.chat-message {
  background: #2a1a0a;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 10px;
  border-left: 3px solid #d4a23c;
}

.message-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 12px;
}

.message-username {
  font-weight: bold;
  color: #d4a23c;
}

.message-time {
  color: #c4a872;
}

.message-text {
  color: #f6e0b2;
  font-size: 14px;
}

.chat-input-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.input-field {
  width: 100%;
  padding: 12px;
  background: #1a1a1a;
  border: 2px solid #5e4528;
  border-radius: 8px;
  color: #f6e0b2;
  font-size: 14px;
  font-family: inherit;
}

.input-field:focus {
  outline: none;
  border-color: #d4a23c;
}

.btn {
  padding: 12px 24px;
  background: linear-gradient(135deg, #d4a23c, #b88a28);
  border: none;
  border-radius: 8px;
  color: #1a1a1a;
  font-weight: bold;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(212, 162, 60, 0.5);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.info-text {
  font-size: 12px;
  color: #c4a872;
  text-align: center;
  padding: 10px;
  background: rgba(212, 162, 60, 0.1);
  border-radius: 6px;
  margin-top: 10px;
}

.no-activity {
  text-align: center;
  color: #c4a872;
  padding: 20px;
  font-style: italic;
}

.loading {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #d4a23c;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.settings-display {
  background: #1a1a1a;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 10px;
  border: 2px solid #5e4528;
}

.settings-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #3a2a1a;
}

.settings-row:last-child {
  border-bottom: none;
}

.settings-label {
  color: #d4a23c;
  font-size: 13px;
}

.settings-value {
  color: #f6e0b2;
  font-weight: bold;
  font-size: 13px;
}

@media (max-width: 1200px) {
  .main-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo">
      <div class="logo-icon">üêÜ</div>
      <div class="logo-text">
        <h1>Merle Cam</h1>
      </div>
    </div>
    <div class="status">
      <div class="status-badge">
        <span class="status-dot" id="statusDot"></span>
        <span id="connectionStatus">Connecting...</span>
      </div>
      <div class="status-badge">
        <span id="uptimeDisplay">00:00:00</span>
      </div>
    </div>
  </div>

  <div class="main-grid">
    <div>
      <div class="video-section">
        <img id="videoFeed" src="" alt="Loading camera feed...">
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>üí° Brightness</h3>
          <div class="stat-value" id="brightness">--</div>
          <div class="stat-label">Average</div>
        </div>
        <div class="stat-card">
          <h3>üéØ FPS</h3>
          <div class="stat-value" id="fps">--</div>
          <div class="stat-label">Actual</div>
        </div>
        <div class="stat-card">
          <h3>üìπ Frames</h3>
          <div class="stat-value" id="frames">--</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <h3>üí¨ Messages</h3>
          <div class="stat-value" id="messages">--</div>
          <div class="stat-label">Sent</div>
        </div>
        <div class="stat-card">
          <h3>üõ°Ô∏è Filtered</h3>
          <div class="stat-value" id="filtered">--</div>
          <div class="stat-label">Blocked</div>
        </div>
        <div class="stat-card">
          <h3>ü§ñ AI</h3>
          <div class="stat-value" id="aiResponses">--</div>
          <div class="stat-label">Replies</div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="panel">
        <h2>üí¨ Chat</h2>
        <div class="chat-messages" id="chatMessages">
          <div class="no-activity">Loading messages...</div>
        </div>
        <div class="chat-input-group">
          <input type="text" class="input-field" id="username" placeholder="Your username">
          <input type="text" class="input-field" id="messageInput" placeholder="Type a message...">
          <button class="btn" id="sendBtn">üì§ Send Message</button>
        </div>
      </div>

      <div class="panel">
        <h2>ü§ñ AI Assistant</h2>
        <div class="chat-messages" id="aiMessages">
          <div class="no-activity">Ask Merle anything!</div>
        </div>
        <div class="chat-input-group">
          <input type="text" class="input-field" id="aiInput" placeholder="Ask AI...">
          <button class="btn" id="aiBtn">ü§ñ Ask AI</button>
        </div>
      </div>

      <div class="panel">
        <h2>‚öôÔ∏è Settings (Read-Only)</h2>
        <div class="settings-display">
          <div class="settings-row">
            <span class="settings-label">FPS Target:</span>
            <span class="settings-value" id="settingsFps">--</span>
          </div>
          <div class="settings-row">
            <span class="settings-label">Motion Detection:</span>
            <span class="settings-value" id="settingsMotion">--</span>
          </div>
          <div class="settings-row">
            <span class="settings-label">Profanity Filter:</span>
            <span class="settings-value" id="settingsFilter">--</span>
          </div>
          <div class="settings-row">
            <span class="settings-label">AI Enabled:</span>
            <span class="settings-value" id="settingsAI">--</span>
          </div>
        </div>
        <div class="info-text">
          üîí Settings controlled by backend only
        </div>
      </div>
    </div>
  </div>
</div>

<script>
console.log('üêÜ Merle Cam initializing...');

// Configuration
const API_URL = 'https://scoop-rogers-drainage-lace.trycloudflare.com';
console.log('üì° API URL:', API_URL);

// State
let username = localStorage.getItem('merle_username') || '';
let lastMessageId = 0;

// Initialize username
if (username) {
  document.getElementById('username').value = username;
}

// Initialize video
function initVideo() {
  const video = document.getElementById('videoFeed');
  const videoUrl = `${API_URL}/video?t=${Date.now()}`;
  console.log('üìπ Loading video from:', videoUrl);
  video.src = videoUrl;
  
  video.onerror = (e) => {
    console.error('‚ùå Video load error:', e);
    console.error('Video URL:', video.src);
  };
  
  video.onload = () => {
    console.log('‚úÖ Video loaded successfully');
  };
}

// Format uptime
function formatUptime(seconds) {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

// Update status
async function updateStatus() {
  try {
    const response = await fetch(`${API_URL}/status`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    console.log('üìä Status updated:', data);
    
    // Update connection status
    document.getElementById('statusDot').classList.remove('error');
    document.getElementById('connectionStatus').textContent = 'Connected';
    
    // Update stats
    document.getElementById('uptimeDisplay').textContent = formatUptime(data.uptime);
    document.getElementById('brightness').textContent = Math.round(data.brightness || 0);
    document.getElementById('fps').textContent = data.fps_actual || 0;
    document.getElementById('frames').textContent = (data.frame_count || 0).toLocaleString();
    document.getElementById('messages').textContent = data.total_messages || 0;
    document.getElementById('filtered').textContent = data.filtered_messages || 0;
    document.getElementById('aiResponses').textContent = data.ai_responses || 0;
    
    // Update settings display
    if (data.settings) {
      document.getElementById('settingsFps').textContent = data.settings.fps + ' FPS';
      document.getElementById('settingsMotion').textContent = data.settings.motion ? 'ON ‚úÖ' : 'OFF ‚ùå';
      document.getElementById('settingsFilter').textContent = data.settings.profanity_filter ? 'ON ‚úÖ' : 'OFF ‚ùå';
      document.getElementById('settingsAI').textContent = data.settings.ai_enabled ? 'ON ‚úÖ' : 'OFF ‚ùå';
    }
    
  } catch (error) {
    console.error('‚ùå Status update failed:', error);
    document.getElementById('statusDot').classList.add('error');
    document.getElementById('connectionStatus').textContent = 'Disconnected';
  }
}

// Update chat
async function updateChat() {
  try {
    const response = await fetch(`${API_URL}/chat/messages`);
    if (!response.ok) return;
    
    const data = await response.json();
    const messages = data.messages || [];
    
    if (messages.length === 0) {
      document.getElementById('chatMessages').innerHTML = '<div class="no-activity">No messages yet</div>';
      return;
    }
    
    const latestId = messages[messages.length - 1]?.id || 0;
    if (latestId > lastMessageId) {
      lastMessageId = latestId;
      
      const chatHtml = messages.map(msg => `
        <div class="chat-message">
          <div class="message-header">
            <span class="message-username">${escapeHtml(msg.username)}</span>
            <span class="message-time">${msg.time_str}</span>
          </div>
          <div class="message-text">${escapeHtml(msg.text)}</div>
        </div>
      `).join('');
      
      const chatContainer = document.getElementById('chatMessages');
      chatContainer.innerHTML = chatHtml;
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
  } catch (error) {
    console.error('‚ùå Chat update failed:', error);
  }
}

// Send message
async function sendMessage() {
  const usernameInput = document.getElementById('username');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  
  const user = usernameInput.value.trim();
  const text = messageInput.value.trim();
  
  if (!user) {
    alert('Please enter a username');
    return;
  }
  
  if (!text) {
    alert('Please enter a message');
    return;
  }
  
  localStorage.setItem('merle_username', user);
  
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<div class="loading"></div>';
  
  try {
    const response = await fetch(`${API_URL}/chat/send`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: user, text })
    });
    
    const result = await response.json();
    
    if (result.success) {
      messageInput.value = '';
      await updateChat();
    } else {
      alert(result.error || 'Failed to send message');
    }
    
  } catch (error) {
    console.error('‚ùå Send failed:', error);
    alert('Failed to send message');
  } finally {
    sendBtn.disabled = false;
    sendBtn.innerHTML = 'üì§ Send Message';
  }
}

// Send AI message
async function sendAI() {
  const aiInput = document.getElementById('aiInput');
  const aiBtn = document.getElementById('aiBtn');
  
  const text = aiInput.value.trim();
  
  if (!text) {
    alert('Please enter a question');
    return;
  }
  
  const user = localStorage.getItem('merle_username') || 'Guest';
  
  aiBtn.disabled = true;
  aiBtn.innerHTML = '<div class="loading"></div>';
  
  try {
    const response = await fetch(`${API_URL}/ai/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, username: user })
    });
    
    const result = await response.json();
    
    if (result.success) {
      aiInput.value = '';
      
      const now = new Date();
      const time = now.toTimeString().split(' ')[0].substring(0, 5);
      
      const aiContainer = document.getElementById('aiMessages');
      if (aiContainer.innerHTML.includes('no-activity')) {
        aiContainer.innerHTML = '';
      }
      
      aiContainer.innerHTML += `
        <div class="chat-message">
          <div class="message-header">
            <span class="message-username">${escapeHtml(user)}</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-text">${escapeHtml(text)}</div>
        </div>
        <div class="chat-message">
          <div class="message-header">
            <span class="message-username">Merle AI üêÜ</span>
            <span class="message-time">${time}</span>
          </div>
          <div class="message-text">${escapeHtml(result.response)}</div>
        </div>
      `;
      
      aiContainer.scrollTop = aiContainer.scrollHeight;
    } else {
      alert(result.error || 'AI not available');
    }
    
  } catch (error) {
    console.error('‚ùå AI failed:', error);
    alert('Failed to get AI response');
  } finally {
    aiBtn.disabled = false;
    aiBtn.innerHTML = 'ü§ñ Ask AI';
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Event listeners
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('aiBtn').addEventListener('click', sendAI);

document.getElementById('messageInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendMessage();
});

document.getElementById('aiInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendAI();
});

// Initialize
console.log('üß™ Testing backend connection...');
fetch(`${API_URL}/health`)
  .then(response => response.json())
  .then(data => {
    console.log('‚úÖ Backend connected:', data);
    console.log('Camera active:', data.camera_active);
    
    initVideo();
    updateStatus();
    updateChat();
    
    setInterval(updateStatus, 3000);
    setInterval(updateChat, 2000);
  })
  .catch(error => {
    console.error('‚ùå Backend connection failed:', error);
    console.error('Make sure backend is running at:', API_URL);
    document.getElementById('statusDot').classList.add('error');
    document.getElementById('connectionStatus').textContent = 'Backend Offline';
    
    // Try to load video anyway
    initVideo();
  });

console.log('‚úÖ Frontend initialized');
</script>

</body>
</html>
